version: "3.8"

services:

  postgres:
    image: docker.io/postgres:17.5
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust
      POSTGRES_DB: k3s
    volumes:
      - pgdata:/var/lib/postgresql/data:Z
    networks:
      homelabnetwork:
        ipv4_address: 192.168.4.3
    expose:
      - "5432"


  k3s-server-1:
    image: "docker.io/rancher/k3s:${K3S_VERSION:-latest}"
    command: server
    tmpfs:
      - /run
      - /var/run
    privileged: true
    restart: always
    environment:
      - K3S_TOKEN="93889e98288eefd653c4ce0ac0debdd4ae4b366ec87f9ea13f2b5894dfdea9235aa64f37a965d50b84245bb1e700e602daba9f44443ce18b1238702b3cea5052361d5a8bbcb1c6a06e8827b21abd58de98fd871e5086e26d6e8de16b5dd6880d690c315bfb7c00a12f0069b26bb66d1e9cee53ca2ca2a35a1ad45fe03df509b1fea32730da0622350ea66f8baec7fd93ae3da7b3163fe9a4061c4d3e9faff3e0f11a9014b0b8d612053f6a915693b0daa2edcfdde0f79a88d13af99fbb5f081f0f64ba0e057afc76394ff9597eb81f8d29600f2b1efe993c50e8e2f1075c8c6b3da91ce6715954cbc66b7af6f9ef518e71b72a5703dff4bcc9629ef032135285cd649fd314ba698a838b7d56464326db129d2deed04f1bb0ecfa7dbc901d167915586dece3a87ff949b857470aa9f627257226966501ecb796542793cf9a51aabbd070d70b4ab43a553de300d78c66af817014d463adffa7256274bd51533d6afbaa42689f2e2442f1422d13bd2a6376a69d6886673ad2dcc7fd1b6927f358fd27dfea0a760b70a0125d63d61b2c2af745e3e6b320c0f6bcf0a59ea87bce228eac858afefdc4df71c2a917db07bc6cd2cc497774cb041e83942f58088478509b46701e4421ac8c80e25577ed79b6b2532c143d87adbcc67abc55c75ec0632b3d709a38ff24a61b028550b2de284030be6843074cd23bf2df0bf6a239977588b5807ea2e809fc4429a70dabfb1bdd5e40f119b39d7c473359e7595f03311936810ebf44935b88ee59c5ec63d3399ecdb2f86fe09b037e5cbe086695535e40ee7c00d80c786c7b86b65f1ba8a37bb444350080b81e0fed58e6d42cf9d4e8c18782eed9dfeb6c83730503cd5727f91e5b0b62cb57ef9da27789cbb21bf909ddadbd1c8897da9d63c87c957bc57142e2e2da1563027f3b3d9427e021ac2bdb87dd127146fce6be2ce5678a70a72307f1110553272b67a2b9aaf6eb311d23992da8d359a71d3b11e54d0c5c00c4ed05133fe5384b41a3ec6072583ec82452b19e980839a3211e587d394a8845beb74e7bc484bf576500331db194ca194f8c086c4094fa9b5c9ce608df3948b16cdde6dc131f2af31af0a2202b7199295b550870a8cb77ab4b913fefce658d58a543e80feec9fc98a0b0b256af9e83500bbbd6f8f89a574fe1336c1529ce7f2141c6fb591d52d5aed3c08bcbcca9d43e05ab72fac57a81ff37372a80f72db392ba3fbf5e1b9f6f5079ea5023452f17f6cdea04e47d5cb950747f33f46b60827637444ca4beeadb014f9f5b0b7adb5162279c48660247b0e3db54f4082f98161a9d10e5a5306b29ff1757ddc99a4fd2577721a0eaeec1ee6b5ad92c742ae0d6a9fbed292cf93b7af3a87dcbcb56217d9059c468e611f9335c117e07abe0c8be1b2f78436b65567ef4ac4aa006c00bf7b36ac27b551990"
      - K3S_KUBECONFIG_OUTPUT=/output/kubeconfig.yaml
      - K3S_BIND_ADDRESS=192.168.4.10
      - K3S_KUBECONFIG_MODE=666
      - K3S_DATASTORE_ENDPOINT=postgres://postgres@192.168.4.3:5432/k3s
      - K3S_NODE_NAME=k3s-server-1
    volumes:
      - .:/output:Z
    networks:
      homelabnetwork:
        ipv4_address: 192.168.4.10
    expose:
      - "6443"
      - "80"
      - "443"

  k3s-server-2:
    image: "docker.io/rancher/k3s:${K3S_VERSION:-latest}"
    command: server
    tmpfs:
      - /run
      - /var/run
    privileged: true
    restart: always
    environment:
      - K3S_TOKEN="93889e98288eefd653c4ce0ac0debdd4ae4b366ec87f9ea13f2b5894dfdea9235aa64f37a965d50b84245bb1e700e602daba9f44443ce18b1238702b3cea5052361d5a8bbcb1c6a06e8827b21abd58de98fd871e5086e26d6e8de16b5dd6880d690c315bfb7c00a12f0069b26bb66d1e9cee53ca2ca2a35a1ad45fe03df509b1fea32730da0622350ea66f8baec7fd93ae3da7b3163fe9a4061c4d3e9faff3e0f11a9014b0b8d612053f6a915693b0daa2edcfdde0f79a88d13af99fbb5f081f0f64ba0e057afc76394ff9597eb81f8d29600f2b1efe993c50e8e2f1075c8c6b3da91ce6715954cbc66b7af6f9ef518e71b72a5703dff4bcc9629ef032135285cd649fd314ba698a838b7d56464326db129d2deed04f1bb0ecfa7dbc901d167915586dece3a87ff949b857470aa9f627257226966501ecb796542793cf9a51aabbd070d70b4ab43a553de300d78c66af817014d463adffa7256274bd51533d6afbaa42689f2e2442f1422d13bd2a6376a69d6886673ad2dcc7fd1b6927f358fd27dfea0a760b70a0125d63d61b2c2af745e3e6b320c0f6bcf0a59ea87bce228eac858afefdc4df71c2a917db07bc6cd2cc497774cb041e83942f58088478509b46701e4421ac8c80e25577ed79b6b2532c143d87adbcc67abc55c75ec0632b3d709a38ff24a61b028550b2de284030be6843074cd23bf2df0bf6a239977588b5807ea2e809fc4429a70dabfb1bdd5e40f119b39d7c473359e7595f03311936810ebf44935b88ee59c5ec63d3399ecdb2f86fe09b037e5cbe086695535e40ee7c00d80c786c7b86b65f1ba8a37bb444350080b81e0fed58e6d42cf9d4e8c18782eed9dfeb6c83730503cd5727f91e5b0b62cb57ef9da27789cbb21bf909ddadbd1c8897da9d63c87c957bc57142e2e2da1563027f3b3d9427e021ac2bdb87dd127146fce6be2ce5678a70a72307f1110553272b67a2b9aaf6eb311d23992da8d359a71d3b11e54d0c5c00c4ed05133fe5384b41a3ec6072583ec82452b19e980839a3211e587d394a8845beb74e7bc484bf576500331db194ca194f8c086c4094fa9b5c9ce608df3948b16cdde6dc131f2af31af0a2202b7199295b550870a8cb77ab4b913fefce658d58a543e80feec9fc98a0b0b256af9e83500bbbd6f8f89a574fe1336c1529ce7f2141c6fb591d52d5aed3c08bcbcca9d43e05ab72fac57a81ff37372a80f72db392ba3fbf5e1b9f6f5079ea5023452f17f6cdea04e47d5cb950747f33f46b60827637444ca4beeadb014f9f5b0b7adb5162279c48660247b0e3db54f4082f98161a9d10e5a5306b29ff1757ddc99a4fd2577721a0eaeec1ee6b5ad92c742ae0d6a9fbed292cf93b7af3a87dcbcb56217d9059c468e611f9335c117e07abe0c8be1b2f78436b65567ef4ac4aa006c00bf7b36ac27b551990"
      - K3S_KUBECONFIG_OUTPUT=/output/kubeconfig.yaml
      - K3S_BIND_ADDRESS=192.168.4.11
      - K3S_KUBECONFIG_MODE=666
      - K3S_URL=https://192.168.4.10:6443
      - K3S_DATASTORE_ENDPOINT=postgres://postgres@192.168.4.3:5432/k3s
      - K3S_NODE_NAME=k3s-server-2
    networks:
      homelabnetwork:
        ipv4_address: 192.168.4.11
    expose:
      - "6443"
      - "80"
      - "443"

    depends_on:
      - k3s-server-1


  k3s-server-3:
    image: "docker.io/rancher/k3s:${K3S_VERSION:-latest}"
    command: server
    tmpfs:
      - /run
      - /var/run
    privileged: true
    restart: always
    environment:
      - K3S_TOKEN="93889e98288eefd653c4ce0ac0debdd4ae4b366ec87f9ea13f2b5894dfdea9235aa64f37a965d50b84245bb1e700e602daba9f44443ce18b1238702b3cea5052361d5a8bbcb1c6a06e8827b21abd58de98fd871e5086e26d6e8de16b5dd6880d690c315bfb7c00a12f0069b26bb66d1e9cee53ca2ca2a35a1ad45fe03df509b1fea32730da0622350ea66f8baec7fd93ae3da7b3163fe9a4061c4d3e9faff3e0f11a9014b0b8d612053f6a915693b0daa2edcfdde0f79a88d13af99fbb5f081f0f64ba0e057afc76394ff9597eb81f8d29600f2b1efe993c50e8e2f1075c8c6b3da91ce6715954cbc66b7af6f9ef518e71b72a5703dff4bcc9629ef032135285cd649fd314ba698a838b7d56464326db129d2deed04f1bb0ecfa7dbc901d167915586dece3a87ff949b857470aa9f627257226966501ecb796542793cf9a51aabbd070d70b4ab43a553de300d78c66af817014d463adffa7256274bd51533d6afbaa42689f2e2442f1422d13bd2a6376a69d6886673ad2dcc7fd1b6927f358fd27dfea0a760b70a0125d63d61b2c2af745e3e6b320c0f6bcf0a59ea87bce228eac858afefdc4df71c2a917db07bc6cd2cc497774cb041e83942f58088478509b46701e4421ac8c80e25577ed79b6b2532c143d87adbcc67abc55c75ec0632b3d709a38ff24a61b028550b2de284030be6843074cd23bf2df0bf6a239977588b5807ea2e809fc4429a70dabfb1bdd5e40f119b39d7c473359e7595f03311936810ebf44935b88ee59c5ec63d3399ecdb2f86fe09b037e5cbe086695535e40ee7c00d80c786c7b86b65f1ba8a37bb444350080b81e0fed58e6d42cf9d4e8c18782eed9dfeb6c83730503cd5727f91e5b0b62cb57ef9da27789cbb21bf909ddadbd1c8897da9d63c87c957bc57142e2e2da1563027f3b3d9427e021ac2bdb87dd127146fce6be2ce5678a70a72307f1110553272b67a2b9aaf6eb311d23992da8d359a71d3b11e54d0c5c00c4ed05133fe5384b41a3ec6072583ec82452b19e980839a3211e587d394a8845beb74e7bc484bf576500331db194ca194f8c086c4094fa9b5c9ce608df3948b16cdde6dc131f2af31af0a2202b7199295b550870a8cb77ab4b913fefce658d58a543e80feec9fc98a0b0b256af9e83500bbbd6f8f89a574fe1336c1529ce7f2141c6fb591d52d5aed3c08bcbcca9d43e05ab72fac57a81ff37372a80f72db392ba3fbf5e1b9f6f5079ea5023452f17f6cdea04e47d5cb950747f33f46b60827637444ca4beeadb014f9f5b0b7adb5162279c48660247b0e3db54f4082f98161a9d10e5a5306b29ff1757ddc99a4fd2577721a0eaeec1ee6b5ad92c742ae0d6a9fbed292cf93b7af3a87dcbcb56217d9059c468e611f9335c117e07abe0c8be1b2f78436b65567ef4ac4aa006c00bf7b36ac27b551990"
      - K3S_KUBECONFIG_OUTPUT=/output/kubeconfig.yaml
      - K3S_BIND_ADDRESS=192.168.4.12
      - K3S_KUBECONFIG_MODE=666
      - K3S_URL=https://192.168.4.10:6443
      - K3S_DATASTORE_ENDPOINT=postgres://postgres@192.168.4.3:5432/k3s
      - K3S_NODE_NAME=k3s-server-3
    networks:
      homelabnetwork:
        ipv4_address: 192.168.4.12
    expose:
      - "6443"
      - "80"
      - "443"
    depends_on:
      - k3s-server-1
      - k3s-server-2

  k3s-agent-1:
    image: "docker.io/rancher/k3s:${K3S_VERSION:-latest}"
    tmpfs:
      - /run
      - /var/run
    privileged: true
    restart: always
    environment:
      - K3S_URL=https://192.168.4.10:6443
      - K3S_NODE_NAME=k3s-agent-1
      - K3S_TOKEN="93889e98288eefd653c4ce0ac0debdd4ae4b366ec87f9ea13f2b5894dfdea9235aa64f37a965d50b84245bb1e700e602daba9f44443ce18b1238702b3cea5052361d5a8bbcb1c6a06e8827b21abd58de98fd871e5086e26d6e8de16b5dd6880d690c315bfb7c00a12f0069b26bb66d1e9cee53ca2ca2a35a1ad45fe03df509b1fea32730da0622350ea66f8baec7fd93ae3da7b3163fe9a4061c4d3e9faff3e0f11a9014b0b8d612053f6a915693b0daa2edcfdde0f79a88d13af99fbb5f081f0f64ba0e057afc76394ff9597eb81f8d29600f2b1efe993c50e8e2f1075c8c6b3da91ce6715954cbc66b7af6f9ef518e71b72a5703dff4bcc9629ef032135285cd649fd314ba698a838b7d56464326db129d2deed04f1bb0ecfa7dbc901d167915586dece3a87ff949b857470aa9f627257226966501ecb796542793cf9a51aabbd070d70b4ab43a553de300d78c66af817014d463adffa7256274bd51533d6afbaa42689f2e2442f1422d13bd2a6376a69d6886673ad2dcc7fd1b6927f358fd27dfea0a760b70a0125d63d61b2c2af745e3e6b320c0f6bcf0a59ea87bce228eac858afefdc4df71c2a917db07bc6cd2cc497774cb041e83942f58088478509b46701e4421ac8c80e25577ed79b6b2532c143d87adbcc67abc55c75ec0632b3d709a38ff24a61b028550b2de284030be6843074cd23bf2df0bf6a239977588b5807ea2e809fc4429a70dabfb1bdd5e40f119b39d7c473359e7595f03311936810ebf44935b88ee59c5ec63d3399ecdb2f86fe09b037e5cbe086695535e40ee7c00d80c786c7b86b65f1ba8a37bb444350080b81e0fed58e6d42cf9d4e8c18782eed9dfeb6c83730503cd5727f91e5b0b62cb57ef9da27789cbb21bf909ddadbd1c8897da9d63c87c957bc57142e2e2da1563027f3b3d9427e021ac2bdb87dd127146fce6be2ce5678a70a72307f1110553272b67a2b9aaf6eb311d23992da8d359a71d3b11e54d0c5c00c4ed05133fe5384b41a3ec6072583ec82452b19e980839a3211e587d394a8845beb74e7bc484bf576500331db194ca194f8c086c4094fa9b5c9ce608df3948b16cdde6dc131f2af31af0a2202b7199295b550870a8cb77ab4b913fefce658d58a543e80feec9fc98a0b0b256af9e83500bbbd6f8f89a574fe1336c1529ce7f2141c6fb591d52d5aed3c08bcbcca9d43e05ab72fac57a81ff37372a80f72db392ba3fbf5e1b9f6f5079ea5023452f17f6cdea04e47d5cb950747f33f46b60827637444ca4beeadb014f9f5b0b7adb5162279c48660247b0e3db54f4082f98161a9d10e5a5306b29ff1757ddc99a4fd2577721a0eaeec1ee6b5ad92c742ae0d6a9fbed292cf93b7af3a87dcbcb56217d9059c468e611f9335c117e07abe0c8be1b2f78436b65567ef4ac4aa006c00bf7b36ac27b551990"
    volumes:
      - k3s-agent-1:/var/lib/rancher/k3s:Z
    networks:
      homelabnetwork:
        ipv4_address: 192.168.4.13
    depends_on:
      - k3s-server-3

  k3s-agent-2:
    image: "docker.io/rancher/k3s:${K3S_VERSION:-latest}"
    tmpfs:
      - /run
      - /var/run
    privileged: true
    restart: always
    environment:
      - K3S_URL=https://192.168.4.10:6443
      - K3S_NODE_NAME=k3s-agent-2
      - K3S_TOKEN="93889e98288eefd653c4ce0ac0debdd4ae4b366ec87f9ea13f2b5894dfdea9235aa64f37a965d50b84245bb1e700e602daba9f44443ce18b1238702b3cea5052361d5a8bbcb1c6a06e8827b21abd58de98fd871e5086e26d6e8de16b5dd6880d690c315bfb7c00a12f0069b26bb66d1e9cee53ca2ca2a35a1ad45fe03df509b1fea32730da0622350ea66f8baec7fd93ae3da7b3163fe9a4061c4d3e9faff3e0f11a9014b0b8d612053f6a915693b0daa2edcfdde0f79a88d13af99fbb5f081f0f64ba0e057afc76394ff9597eb81f8d29600f2b1efe993c50e8e2f1075c8c6b3da91ce6715954cbc66b7af6f9ef518e71b72a5703dff4bcc9629ef032135285cd649fd314ba698a838b7d56464326db129d2deed04f1bb0ecfa7dbc901d167915586dece3a87ff949b857470aa9f627257226966501ecb796542793cf9a51aabbd070d70b4ab43a553de300d78c66af817014d463adffa7256274bd51533d6afbaa42689f2e2442f1422d13bd2a6376a69d6886673ad2dcc7fd1b6927f358fd27dfea0a760b70a0125d63d61b2c2af745e3e6b320c0f6bcf0a59ea87bce228eac858afefdc4df71c2a917db07bc6cd2cc497774cb041e83942f58088478509b46701e4421ac8c80e25577ed79b6b2532c143d87adbcc67abc55c75ec0632b3d709a38ff24a61b028550b2de284030be6843074cd23bf2df0bf6a239977588b5807ea2e809fc4429a70dabfb1bdd5e40f119b39d7c473359e7595f03311936810ebf44935b88ee59c5ec63d3399ecdb2f86fe09b037e5cbe086695535e40ee7c00d80c786c7b86b65f1ba8a37bb444350080b81e0fed58e6d42cf9d4e8c18782eed9dfeb6c83730503cd5727f91e5b0b62cb57ef9da27789cbb21bf909ddadbd1c8897da9d63c87c957bc57142e2e2da1563027f3b3d9427e021ac2bdb87dd127146fce6be2ce5678a70a72307f1110553272b67a2b9aaf6eb311d23992da8d359a71d3b11e54d0c5c00c4ed05133fe5384b41a3ec6072583ec82452b19e980839a3211e587d394a8845beb74e7bc484bf576500331db194ca194f8c086c4094fa9b5c9ce608df3948b16cdde6dc131f2af31af0a2202b7199295b550870a8cb77ab4b913fefce658d58a543e80feec9fc98a0b0b256af9e83500bbbd6f8f89a574fe1336c1529ce7f2141c6fb591d52d5aed3c08bcbcca9d43e05ab72fac57a81ff37372a80f72db392ba3fbf5e1b9f6f5079ea5023452f17f6cdea04e47d5cb950747f33f46b60827637444ca4beeadb014f9f5b0b7adb5162279c48660247b0e3db54f4082f98161a9d10e5a5306b29ff1757ddc99a4fd2577721a0eaeec1ee6b5ad92c742ae0d6a9fbed292cf93b7af3a87dcbcb56217d9059c468e611f9335c117e07abe0c8be1b2f78436b65567ef4ac4aa006c00bf7b36ac27b551990"
    volumes:
      - k3s-agent-2:/var/lib/rancher/k3s:Z
    networks:
      homelabnetwork:
        ipv4_address: 192.168.4.14
    depends_on:
      - k3s-server-3

  k3s-agent-3:
    image: "docker.io/rancher/k3s:${K3S_VERSION:-latest}"
    tmpfs:
      - /run
      - /var/run
    privileged: true
    restart: always
    environment:
      - K3S_URL=https://192.168.4.10:6443
      - K3S_NODE_NAME=k3s-agent-3
      - K3S_TOKEN="93889e98288eefd653c4ce0ac0debdd4ae4b366ec87f9ea13f2b5894dfdea9235aa64f37a965d50b84245bb1e700e602daba9f44443ce18b1238702b3cea5052361d5a8bbcb1c6a06e8827b21abd58de98fd871e5086e26d6e8de16b5dd6880d690c315bfb7c00a12f0069b26bb66d1e9cee53ca2ca2a35a1ad45fe03df509b1fea32730da0622350ea66f8baec7fd93ae3da7b3163fe9a4061c4d3e9faff3e0f11a9014b0b8d612053f6a915693b0daa2edcfdde0f79a88d13af99fbb5f081f0f64ba0e057afc76394ff9597eb81f8d29600f2b1efe993c50e8e2f1075c8c6b3da91ce6715954cbc66b7af6f9ef518e71b72a5703dff4bcc9629ef032135285cd649fd314ba698a838b7d56464326db129d2deed04f1bb0ecfa7dbc901d167915586dece3a87ff949b857470aa9f627257226966501ecb796542793cf9a51aabbd070d70b4ab43a553de300d78c66af817014d463adffa7256274bd51533d6afbaa42689f2e2442f1422d13bd2a6376a69d6886673ad2dcc7fd1b6927f358fd27dfea0a760b70a0125d63d61b2c2af745e3e6b320c0f6bcf0a59ea87bce228eac858afefdc4df71c2a917db07bc6cd2cc497774cb041e83942f58088478509b46701e4421ac8c80e25577ed79b6b2532c143d87adbcc67abc55c75ec0632b3d709a38ff24a61b028550b2de284030be6843074cd23bf2df0bf6a239977588b5807ea2e809fc4429a70dabfb1bdd5e40f119b39d7c473359e7595f03311936810ebf44935b88ee59c5ec63d3399ecdb2f86fe09b037e5cbe086695535e40ee7c00d80c786c7b86b65f1ba8a37bb444350080b81e0fed58e6d42cf9d4e8c18782eed9dfeb6c83730503cd5727f91e5b0b62cb57ef9da27789cbb21bf909ddadbd1c8897da9d63c87c957bc57142e2e2da1563027f3b3d9427e021ac2bdb87dd127146fce6be2ce5678a70a72307f1110553272b67a2b9aaf6eb311d23992da8d359a71d3b11e54d0c5c00c4ed05133fe5384b41a3ec6072583ec82452b19e980839a3211e587d394a8845beb74e7bc484bf576500331db194ca194f8c086c4094fa9b5c9ce608df3948b16cdde6dc131f2af31af0a2202b7199295b550870a8cb77ab4b913fefce658d58a543e80feec9fc98a0b0b256af9e83500bbbd6f8f89a574fe1336c1529ce7f2141c6fb591d52d5aed3c08bcbcca9d43e05ab72fac57a81ff37372a80f72db392ba3fbf5e1b9f6f5079ea5023452f17f6cdea04e47d5cb950747f33f46b60827637444ca4beeadb014f9f5b0b7adb5162279c48660247b0e3db54f4082f98161a9d10e5a5306b29ff1757ddc99a4fd2577721a0eaeec1ee6b5ad92c742ae0d6a9fbed292cf93b7af3a87dcbcb56217d9059c468e611f9335c117e07abe0c8be1b2f78436b65567ef4ac4aa006c00bf7b36ac27b551990"
    volumes:
      - k3s-agent-3:/var/lib/rancher/k3s:Z
    networks:
      homelabnetwork:
        ipv4_address: 192.168.4.15
    depends_on:
      - k3s-server-3

  pihole:
    image: docker.io/pihole/pihole:latest
    container_name: pihole
    privileged: true
    environment:
      - TZ=America/New_York
      - FTLCONF_webserver_api_password=changeme
      - FTLCONF_dns_listeningMode=all
      - FTLCONF_misc_etc_dnsmasq_d=true
    volumes:
      - pihole:/etc/pihole:Z
      - ./dnsmasq-config:/etc/dnsmasq.d:Z
    restart: unless-stopped
    networks:
      homelabnetwork:
        ipv4_address: 192.168.4.2

volumes:
  pgdata: {}
  k3s-agent-1: {}
  k3s-agent-2: {}
  k3s-agent-3: {}
  pihole: {}

networks:
  homelabnetwork:
    name: homelabnetwork
    external: true
